{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}MobilePaytool{% endblock %}
{% block breadcrumbs %}
    <div class="breadcrumbs"><a href="../">Hjem</a></div>{% endblock %}

{% block extrahead %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    {{ formset.media.css }}
    {{ formset.media.js }}
    <style>
        .select2-container {
            min-width: 400px;
            max_width: 400px;
        }

        #wrapper {
            display: flex;
            overflow: hidden;
        }

        #mobilepay-description {
            float: left;
            width: 50%;
            padding-right: 10px;
        }

        #mobilepay-import {
            float: left;
            width: 50%;
            padding-left: 10px;
            border-left: thin dashed grey;
        }
    </style>

{% endblock %}

{% block content %}
    {% load admin_static %}
    {% load stregsystem_extras %}

    <div id="content-main">
        <div id="wrapper">
            <div id="mobilepay-description">
                <h1>MobilePaytool</h1>
                <p>Displays a list of unprocessed MobilePay transactions for easy processing of payments. For each
                    row:</p>
                <ol>

                    <li><p>Input correct member in member column. If prefilled, member wrote their username
                        correctly.</p></li>
                    <li><p>Check <code>Approved</code> if member is correctly filled. If transaction has already been
                        processed (in case of 'tilmelding' or 'er indsat') check <code>Ignored</code>.</p></li>
                </ol>
                <p>Clicking <code>Submit payments</code> will process all <code>Approved</code> and <code>Ignored</code>
                    transactions.</p>
                <i>Pro tip: A good workflow is marking the member-field, completing it, using tab to access status,
                    using arrow-keys to choose status and pressing tab to go to next row.</i>

            </div>
            <div id="mobilepay-import">

                <h1>Import MobilePay CSV transactions</h1>
                <p><i>Existing MobilePay transactions are ignored, this function is <a
                        href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a></i></p>
                <form method="post" enctype="multipart/form-data"> {% csrf_token %}
                    <input type="file" name="csv_file" id="csv_file" accept="text/csv"/>
                    <input type="submit" value="Submit MobilePay CSV"/>
                </form>
                {% if imports or duplicates %}
                    <h2> Imported {{ imports }} MobilePay transactions{% if duplicates %}, and ignored {{ duplicates }}
                        duplicates {% endif %} </h2>
                {% endif %}

            </div>
        </div>
        <br>
        <hr style="height: 3px">
        <br>
        <center>
            {% if not formset.forms %}
                <h2> No MobilePay transactions needs processing</h2>
            {% endif %}
            <form method="post"> {% csrf_token %}
                {{ formset.management_form }}
                {{ formset.non_form_errors.as_ul }}
                <table id="formset" class="form">
                    {% for form in formset.forms %}
                        {% if forloop.first %}
                            <thead>
                            <tr>
                                {% for field in form.visible_fields %}
                                    <th>{{ field.label|capfirst }}</th>
                                {% endfor %}
                            </tr>
                            </thead>
                        {% endif %}
                        <tr class="{% cycle row1 row2 %}">
                            {% for field in form.visible_fields %}
                                <td>
                                    {# Include the hidden fields in the form #}
                                    {% if forloop.first %}
                                        {% for hidden in form.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    {% endif %}
                                    {{ field.errors.as_ul }}

                                    {#  Modify non-editable fields for printing only and hide real widgets #}
                                    {% if field.name == "amount" %}
                                        {{ field.value|money }} DKK
                                        <span style="visibility: hidden; position: absolute">{{ field }}</span>
                                    {% elif field.name == "member_guess" %}
                                        {{ field.value|get_member_str_key|safe }}
                                        <span style="visibility: hidden; position: absolute">{{ field }}</span>
                                    {% elif field.name == "customer_name" %}
                                        {{ field.value }}
                                        <span style="visibility: hidden; position: absolute">{{ field }}</span>
                                    {% elif field.name == "comment" %}
                                        {{ field.value }}
                                        <span style="visibility: hidden; position: absolute">{{ field }}</span>
                                    {% elif field.name == "status" %}
                                        {% for radio in form.status %}
                                            {{ radio }}
                                        {% endfor %}
                                    {% else %}
                                        {{ field }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </table>
                <br>
                <hr style="height: 3px">
                <br>
                <input type="submit" value="Submit payments"/>
            </form>
        </center>
    </div>
{% endblock %}
